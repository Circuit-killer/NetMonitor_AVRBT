/* * Project: Bluetooth Net Monitor * Author: Zak Kemble, contact@zakkemble.co.uk * Copyright: (C) 2014 by Zak Kemble * License: GNU GPL v3 (see License.txt) * Web: http://blog.zakkemble.co.uk/bluetooth-net-monitor-v2/ */#include "common.h"static void openSocket(void);static char* btAddr;static char* btDev;static char* btPin;static int s;void rfcomm_init(){	config_val("btaddr", &btAddr);	config_val("btdev", &btDev);	config_val("btpin", &btPin);	openSocket();}void rfcomm_end(){	free(btAddr);	free(btDev);	free(btPin);	close(s);}void rfcomm_send(void* data, size_t len){	ssize_t res = write(s, data, len);	// Error occurred, try closing and opening port	if(res < 0)	{		perror("Net Monitor write error");		close(s);		openSocket();		// Try writing again?	}}static void openSocket(){	s = socket(AF_BLUETOOTH, SOCK_STREAM, BTPROTO_RFCOMM);	struct sockaddr_rc addr = { 0 };	addr.rc_family	= AF_BLUETOOTH;	addr.rc_channel	= (uint8_t)1;	str2ba(btAddr, &addr.rc_bdaddr);		puts("Connecting to Net Monitor...");	int status = connect(s, (struct sockaddr*)&addr, sizeof(addr));		if(status < 0)	{		puts("Connection failed");		return;	}	puts("Connected, waiting 2 seconds for things to complete...");	// Still needs a few more seconds to complete	sleep(2);	puts("Done");}